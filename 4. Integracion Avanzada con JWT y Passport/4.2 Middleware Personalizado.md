4.2 Middleware Personalizado
Middleware Personalizado
Desarrollo de un Middleware Personalizado para la Gestión de Roles y Control de Accesos
En aplicaciones que manejan diferentes niveles de permisos de usuario, es fundamental tener un sistema robusto de gestión de roles y control de accesos. Un middleware personalizado para la gestión de roles permite restringir el acceso a ciertas rutas en función del rol del usuario (por ejemplo, administrador, editor, usuario básico).

Desarrollo del Middleware de Gestión de Roles
Este middleware verifica si un usuario autenticado tiene el rol necesario para acceder a una ruta específica y permite o deniega el acceso en función de su rol.

Definición del Middleware: El middleware se define como una función que toma los roles permitidos como argumento y verifica si el usuario tiene uno de estos roles.

Lógica del Middleware:
El middleware verifica si el usuario está autenticado.

Si el usuario no está autenticado, devuelve un error indicando que se requiere autenticación.

Si el usuario está autenticado, el middleware verifica si su rol coincide con los roles permitidos.

Si el rol es válido, permite el acceso a la ruta; de lo contrario, devuelve un mensaje de acceso denegado.


Uso del Middleware en Rutas Protegidas: Este middleware se aplica a las rutas que requieren control de acceso basado en roles.

Ejemplo de Implementación del Middleware de Roles:

Define un middleware que toma un array de roles permitidos como argumento. En la función, verifica si el usuario está autenticado y si su rol está incluido en la lista de roles permitidos.

Si el usuario cumple los requisitos, llama a la siguiente función en la cadena de middleware; si no, responde con un mensaje de error.

Creación de un Custom Call en Passport para Manejar Errores y Mensajes Personalizados
Passport permite manejar errores y mensajes de autenticación de manera más personalizada mediante la creación de un Custom Callback. Un Custom Callback permite tener un control detallado sobre el proceso de autenticación, gestionando los errores y respuestas de manera específica según las necesidades de la aplicación.

Implementación del Custom Callback en Passport
Configuración de Passport con Estrategia JWT o Local: Antes de crear el Custom Callback, asegúrate de tener configurada una estrategia de autenticación en Passport, como JWT o Local.

Definición del Custom Callback:
El Custom Callback es una función que se utiliza en lugar de la función predeterminada de Passport para manejar la autenticación.

El Callback recibe los parámetros: req (solicitud), res (respuesta), y next (siguiente middleware), así como err (error), user (usuario autenticado), y info (mensajes informativos).


Lógica del Custom Callback:
Primero, verifica si hay un error en la autenticación y responde con un mensaje de error específico.

Luego, verifica si el usuario no está autenticado (por ejemplo, credenciales incorrectas) y envía un mensaje personalizado de error o rechazo.

Si el usuario está autenticado, se almacena en la sesión o se genera un JWT y se envía al cliente.


Ejemplo de Implementación de un Custom Callback en Passport:

Configura la autenticación utilizando Passport y especifica un Custom Callback en la ruta de autenticación.

En el Custom Callback, maneja los errores y los casos de éxito de manera personalizada, proporcionando mensajes claros y específicos para cada situación.

Flujo del Custom Callback:

Si hay un error durante la autenticación, el Callback devuelve un mensaje de error específico.

Si el usuario no existe o la autenticación falla, devuelve un mensaje personalizado, como “Usuario no encontrado” o “Contraseña incorrecta”.

Si la autenticación es exitosa, el usuario es autenticado y se procede según lo definido (como redirigir al dashboard o enviar un JWT).

Conclusión
El desarrollo de un middleware personalizado para la gestión de roles y la implementación de un Custom Callback en Passport son técnicas avanzadas que mejoran la gestión de la autenticación y autorización en aplicaciones Express. Estos enfoques permiten un control detallado sobre el acceso de los usuarios a diferentes partes de la aplicación, asegurando que solo los usuarios con los permisos adecuados puedan acceder a recursos específicos. La capacidad de manejar errores y mensajes de forma personalizada en Passport mejora la experiencia del usuario, proporcionando retroalimentación clara y específica durante el proceso de autenticación.